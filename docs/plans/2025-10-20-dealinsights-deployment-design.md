# DealInsights.ai Deployment Architecture Design

**Date:** 2025-10-20
**Status:** Approved
**Domain:** dealinsights.ai

## Executive Summary

This document outlines the production deployment architecture for the DealInsights.ai PE deal analysis platform. The design uses a hybrid edge architecture with Vercel for the frontend and Cloudflare Workers for the backend, prioritizing security, compliance, and cost efficiency.

**Key Components:**
- Frontend: Vercel (Next.js)
- Backend API: Cloudflare Workers (TypeScript)
- Database: Neon PostgreSQL via Cloudflare Hyperdrive
- Document Storage: Cloudflare R2 (encrypted)
- Domain: dealinsights.ai

**Security Posture:** Enterprise-grade with multi-layer security controls designed to pass security audits.

---

## 1. High-Level Architecture

### Component Layout

```
Internet → Cloudflare CDN
           ├─> Vercel (Frontend - Next.js)
           │   └─> /api/* → Cloudflare Workers (Backend API)
           └─> Cloudflare Workers (Backend API)
               ├─> Cloudflare R2 (Document Storage - encrypted)
               ├─> Hyperdrive → Neon PostgreSQL (Database)
               └─> KV/Durable Objects (Sessions/Rate limiting)
```

### Traffic Flow

1. User accesses app via dealinsights.ai (managed by Cloudflare DNS)
2. Vercel serves Next.js frontend (static + SSR)
3. API calls route to Cloudflare Workers via Cloudflare proxy
4. Workers handle authentication, validate requests
5. Database queries go through Hyperdrive (connection pooling) to Neon PostgreSQL
6. Document uploads → encrypted and stored in R2 with signed URLs
7. All traffic encrypted end-to-end (TLS 1.3)

### Why This Architecture

- **Frontend on Vercel:** Leverages Next.js optimization and edge caching
- **Backend on Workers:** Global edge deployment with minimal latency
- **PostgreSQL unchanged:** Zero schema migration required from development
- **R2 Storage:** S3-compatible with free egress (major cost savings)
- **Hyperdrive:** Solves connection pooling for serverless PostgreSQL access

---

## 2. Security Controls for Document Storage

### Multi-Layer Security Architecture

#### Layer 1: Authentication & Authorization

- **JWT Tokens:** Issued by Workers, validated on every request
- **Token Payload:** user_id, firm_id, role, expiration
- **Firm Isolation:** Users can only access documents where `deal.firm_id = user.firm_id`
- **Role-Based Access:** investor/consultant permissions enforced at API level
- **Token Rotation:** 30-minute expiry with refresh token mechanism

#### Layer 2: Document Upload Security

**Upload Flow:**
1. Client requests signed upload URL from Workers
2. Workers validate: user auth, firm membership, file size limits
3. Generate time-limited (15 min) presigned R2 URL with:
   - Unique document ID (UUID)
   - Allowed content-types (PDF, DOCX only)
   - Max file size (50MB limit)
4. Client uploads directly to R2 using presigned URL
5. Workers receive upload complete webhook
6. Virus scanning (optional: integrate ClamAV or VirusTotal API)
7. Document metadata saved to PostgreSQL with encryption key reference

#### Layer 3: Encryption at Rest

- All R2 documents encrypted with AES-256
- Server-side encryption using Cloudflare-managed keys (default)
- Optional: Customer-managed keys stored in Workers Secrets for rotation control
- Document paths use non-guessable UUIDs: `/uploads/{firm_id}/{deal_id}/{uuid}.{ext}`
- No directory listing enabled on R2 bucket

#### Layer 4: Encryption in Transit

- TLS 1.3 for all connections (Cloudflare enforces)
- HSTS headers force HTTPS
- Certificate pinning optional for mobile clients

#### Layer 5: Access Control

**Document Retrieval Requirements:**
1. Valid JWT token
2. Firm membership check: `user.firm_id == document.deal.firm_id`
3. Time-limited signed download URL (5 min expiry)
4. Audit log entry created before URL generation

**R2 Bucket Policy (Private by Default):**
- No public access
- Access only via presigned URLs generated by Workers
- URLs expire after use or timeout

#### Layer 6: Audit Logging

**Every document operation logged to PostgreSQL:**
- Table: `document_audit_logs`
- Fields: user_id, action (upload/view/download/delete), document_id, ip_address, timestamp, metadata (file_size, mime_type)
- Immutable logs (append-only, no deletion)
- Retention: 7 years for compliance
- Real-time alerts on anomalies (unusual download volume, access from new IPs)

#### Layer 7: Data Isolation & Deletion

- **Soft Delete:** Documents marked deleted but retained for 30 days
- **Hard Delete:** Permanent removal from R2 after retention period
- **Firm Data Isolation:** All queries filtered by firm_id
- **No Cross-Firm Leakage:** Enforced at DB level with Row Level Security (RLS)

### Security Controls Checklist for Audit

- ✅ Authentication (JWT with expiry)
- ✅ Authorization (firm-level + role-based)
- ✅ Encryption at rest (AES-256)
- ✅ Encryption in transit (TLS 1.3)
- ✅ Access logging (comprehensive audit trail)
- ✅ Data isolation (firm-level separation)
- ✅ Secure deletion (soft delete + hard delete)
- ✅ File validation (type, size limits)
- ✅ Presigned URLs (time-limited access)
- ✅ No public access (private bucket)

---

## 3. Deployment Configuration

### Frontend (Vercel)

**vercel.json:**
```json
{
  "buildCommand": "npm run build",
  "framework": "nextjs",
  "env": {
    "NEXT_PUBLIC_API_URL": "https://api.dealinsights.ai",
    "NEXT_PUBLIC_ENV": "production"
  },
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Frame-Options",
          "value": "DENY"
        },
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "Referrer-Policy",
          "value": "strict-origin-when-cross-origin"
        },
        {
          "key": "Permissions-Policy",
          "value": "camera=(), microphone=(), geolocation=()"
        }
      ]
    }
  ],
  "rewrites": [
    {
      "source": "/api/:path*",
      "destination": "https://api.dealinsights.ai/:path*"
    }
  ]
}
```

### Backend (Cloudflare Workers)

**wrangler.toml:**
```toml
name = "insight-console-api"
main = "src/index.ts"
compatibility_date = "2024-01-01"

[env.production]
vars = { ENVIRONMENT = "production" }
r2_buckets = [
  { binding = "DOCUMENTS", bucket_name = "insight-console-docs-prod" }
]
kv_namespaces = [
  { binding = "SESSIONS", id = "your-kv-namespace-id" }
]
hyperdrive = [
  { binding = "DATABASE", id = "your-hyperdrive-id" }
]

[[unsafe.bindings]]
name = "DATABASE_URL"
type = "secret"

[[unsafe.bindings]]
name = "ANTHROPIC_API_KEY"
type = "secret"

[[unsafe.bindings]]
name = "JWT_SECRET"
type = "secret"

[observability]
enabled = true
head_sampling_rate = 1
```

### Database (Neon PostgreSQL)

**Configuration:**
- Region: Same as primary user base (e.g., us-east-1)
- Tier: Scale tier (autoscaling, pooling included)
- Connection: Via Cloudflare Hyperdrive for connection pooling
- Backups: Daily automated backups, 30-day retention
- Encryption: Encryption at rest enabled (default)
- Access: IP whitelist (Cloudflare IPs only)

### R2 Bucket Configuration

```javascript
{
  "name": "insight-console-docs-prod",
  "location": "auto",
  "storageClass": "Standard",
  "publicAccess": false,
  "corsPolicy": {
    "allowedOrigins": ["https://dealinsights.ai"],
    "allowedMethods": ["GET", "PUT"],
    "allowedHeaders": ["*"],
    "maxAgeSeconds": 3600
  },
  "lifecycleRules": [
    {
      "id": "delete-old-soft-deleted",
      "status": "Enabled",
      "filter": { "prefix": "deleted/" },
      "expiration": { "days": 30 }
    }
  ]
}
```

### Environment Variables Setup

```bash
# Cloudflare Workers Secrets
wrangler secret put DATABASE_URL
wrangler secret put ANTHROPIC_API_KEY
wrangler secret put JWT_SECRET
wrangler secret put ENCRYPTION_KEY

# Vercel Environment Variables
vercel env add NEXT_PUBLIC_API_URL production
vercel env add NEXT_PUBLIC_ENV production
```

### Domain & DNS Configuration

**Cloudflare DNS:**
- dealinsights.ai → Vercel (CNAME)
- api.dealinsights.ai → Cloudflare Workers (AAAA record)
- SSL/TLS: Full (strict) mode
- Always Use HTTPS: On
- Minimum TLS Version: 1.3
- HTTP Strict Transport Security (HSTS): Enabled

---

## 4. Code Migration & Adaptation

### Converting FastAPI to Cloudflare Workers

**Recommended Approach: Rewrite in TypeScript**

The current FastAPI/Python backend will be rewritten in TypeScript for Cloudflare Workers using the Hono framework (similar to Express/FastAPI).

### Migration Strategy

**Phase 1: Core API Routes (Week 1)**
- Convert authentication (JWT validation)
- Convert deals CRUD endpoints
- Convert document upload/download endpoints
- Keep same REST API contract (frontend unchanged)

**Phase 2: AI Workflows (Week 2)**
- Call Anthropic API from Workers
- Scope extraction agent
- Workflow execution (competitive analysis, etc.)
- Store results in PostgreSQL via Hyperdrive

**Phase 3: Database Integration (Week 3)**
- Configure Hyperdrive connection to Neon
- Migrate SQLAlchemy queries to SQL/Drizzle ORM
- Set up connection pooling
- Test transaction handling

### Key Code Patterns

**Authentication Middleware:**
```typescript
import { verify } from 'hono/jwt';

async function authenticate(c, next) {
  const token = c.req.header('Authorization')?.replace('Bearer ', '');
  if (!token) return c.json({ error: 'Unauthorized' }, 401);

  try {
    const payload = await verify(token, c.env.JWT_SECRET);
    c.set('user', payload);
    await next();
  } catch {
    return c.json({ error: 'Invalid token' }, 401);
  }
}
```

**Firm Isolation Enforcement:**
```typescript
async function enforceFirmIsolation(c, next) {
  const user = c.get('user');
  const dealId = c.req.param('id');

  const deal = await c.env.DATABASE.prepare(
    'SELECT firm_id FROM deals WHERE id = ?'
  ).bind(dealId).first();

  if (deal.firm_id !== user.firm_id) {
    return c.json({ error: 'Access denied' }, 403);
  }

  await next();
}
```

**R2 Document Handling:**
```typescript
async function generateSignedUploadUrl(env, firmId, dealId, filename) {
  const key = `${firmId}/${dealId}/${crypto.randomUUID()}-${filename}`;

  const url = await env.DOCUMENTS.createMultipartUpload(key, {
    httpMetadata: {
      contentType: 'application/pdf',
    },
    customMetadata: {
      firmId,
      dealId,
      uploadedAt: new Date().toISOString(),
    },
  });

  return { url, key };
}
```

### What Stays the Same

- PostgreSQL schema (no changes needed)
- API endpoints and contracts
- Authentication flow (JWT)
- Frontend code (just change API_URL)

### What Changes

- Runtime: Python → TypeScript/JavaScript
- Server: Uvicorn → Cloudflare Workers
- ORM: SQLAlchemy → Raw SQL or Drizzle ORM
- File storage: Local uploads/ → R2

---

## 5. Monitoring, Observability & Incident Response

### Monitoring Stack

**Key Metrics to Track:**

**Application Metrics:**
- API response times (p50, p95, p99)
- Error rates by endpoint
- Document upload success/failure rates
- Authentication failures
- AI workflow execution times
- Database query performance

**Security Metrics:**
- Failed authentication attempts (rate limiting triggers)
- Unusual document access patterns
- Download volume per user/firm
- Access from new IP addresses
- Token expiration events
- Presigned URL generation rate

**Infrastructure Metrics:**
- Cloudflare Workers CPU time
- R2 storage usage and costs
- Database connection pool utilization
- Hyperdrive query latency
- Cache hit rates

### Structured Logging

```typescript
interface LogEntry {
  timestamp: string;
  level: 'INFO' | 'WARN' | 'ERROR' | 'SECURITY';
  service: 'api' | 'auth' | 'documents' | 'workflows';
  userId?: number;
  firmId?: string;
  action: string;
  metadata: Record<string, any>;
  duration?: number;
  error?: string;
}

async function logSecurityEvent(env, event: SecurityEvent) {
  await env.SECURITY_LOGS.put(
    `security/${event.timestamp}/${crypto.randomUUID()}`,
    JSON.stringify({
      timestamp: event.timestamp,
      level: 'SECURITY',
      type: event.type,
      userId: event.userId,
      firmId: event.firmId,
      ipAddress: event.ipAddress,
      details: event.details,
    })
  );

  if (event.severity === 'HIGH') {
    await sendAlert(env, event);
  }
}
```

### Alerting Rules

```yaml
alerts:
  - name: High Error Rate
    condition: error_rate > 5% for 5 minutes
    severity: HIGH
    notify: [engineering-team, on-call]

  - name: Authentication Failures Spike
    condition: auth_failures > 10 per minute from single IP
    severity: CRITICAL
    notify: [security-team, on-call]
    action: auto-block IP after 20 failures

  - name: Unusual Document Access
    condition: documents_downloaded > 50 in 10 minutes by single user
    severity: MEDIUM
    notify: [security-team]
    action: log for review

  - name: Database Connection Pool Exhausted
    condition: hyperdrive_pool_utilization > 90%
    severity: HIGH
    notify: [engineering-team]
    action: scale database connections

  - name: R2 Storage Quota
    condition: r2_storage > 80% of quota
    severity: MEDIUM
    notify: [engineering-team]

  - name: API Latency Degradation
    condition: p95_latency > 2000ms for 5 minutes
    severity: HIGH
    notify: [engineering-team, on-call]
```

### Incident Response Playbook

**Security Incident:**
1. **Detection:** Alert triggered or manual report
2. **Triage:**
   - Check security logs for affected users/firms
   - Identify scope (single user, firm, or platform-wide)
   - Determine attack vector
3. **Containment:**
   - Revoke compromised JWT tokens
   - Block malicious IPs via Cloudflare WAF
   - Disable affected user accounts if needed
   - Rotate secrets if compromised
4. **Investigation:**
   - Pull audit logs for affected timeframe
   - Check for data exfiltration (unusual downloads)
   - Review access patterns
5. **Remediation:**
   - Patch vulnerability
   - Force password reset if needed
   - Update WAF rules
6. **Communication:**
   - Notify affected customers within 24 hours
   - Document incident in security log
   - Post-mortem within 48 hours

**Performance Degradation:**
1. **Detection:** Latency alerts or user reports
2. **Diagnosis:**
   - Check Cloudflare Analytics for bottlenecks
   - Review database query performance
   - Check R2 request latency
   - Review Worker CPU time
3. **Mitigation:**
   - Scale database (Neon autoscaling)
   - Enable aggressive caching
   - Offload heavy operations to queues
4. **Resolution:**
   - Optimize slow queries
   - Add database indexes
   - Implement request throttling if needed

### Audit Log Retention

```sql
CREATE TABLE audit_logs (
  id SERIAL PRIMARY KEY,
  timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  user_id INTEGER REFERENCES users(id),
  firm_id VARCHAR NOT NULL,
  action VARCHAR NOT NULL,
  resource_type VARCHAR NOT NULL,
  resource_id INTEGER,
  ip_address INET,
  user_agent TEXT,
  metadata JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_audit_logs_timestamp ON audit_logs(timestamp DESC);
CREATE INDEX idx_audit_logs_user ON audit_logs(user_id, timestamp DESC);
CREATE INDEX idx_audit_logs_firm ON audit_logs(firm_id, timestamp DESC);

-- Partition by month for performance
-- Retain for 7 years for compliance
```

---

## 6. Deployment Process & Cost Optimization

### CI/CD Pipeline

```yaml
# .github/workflows/deploy-production.yml
name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run Backend Tests
        run: |
          cd backend
          npm install
          npm test

      - name: Run Frontend Tests
        run: |
          cd frontend
          npm install
          npm test

      - name: Security Scan
        run: |
          npm audit

  deploy-backend:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Deploy to Cloudflare Workers
        run: |
          cd backend
          npm install
          npx wrangler deploy --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Run Database Migrations
        run: |
          npx wrangler d1 migrations apply --env production

      - name: Smoke Tests
        run: |
          curl -f https://api.dealinsights.ai/health || exit 1

  deploy-frontend:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Deploy to Vercel
        run: |
          cd frontend
          vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
```

### Deployment Checklist

**Pre-Deployment:**
- [ ] All tests passing (backend + frontend)
- [ ] Security scan clean (no critical vulnerabilities)
- [ ] Database backup created
- [ ] Secrets rotated if needed
- [ ] Review PR and get approval
- [ ] Check monitoring dashboards (baseline metrics)

**Deployment:**
- [ ] Deploy backend to Cloudflare Workers
- [ ] Run database migrations
- [ ] Deploy frontend to Vercel
- [ ] Verify DNS routing
- [ ] Run smoke tests
- [ ] Check error rates in first 10 minutes

**Post-Deployment:**
- [ ] Monitor logs for errors
- [ ] Verify key user flows (login, upload, workflows)
- [ ] Check performance metrics vs baseline
- [ ] Update documentation
- [ ] Notify team of deployment

### Rollback Strategy

```bash
# Backend rollback (Cloudflare Workers)
wrangler rollback --env production

# Frontend rollback (Vercel)
vercel rollback

# Database rollback (if migrations fail)
# Use Neon's point-in-time recovery or restore from backup
```

### Cost Optimization

**Monthly Cost Estimates:**

| Service | Expected Cost (1000 users) | Notes |
|---------|---------------------------|-------|
| Cloudflare Workers | $15-30/month | $5 base + $0.50/M requests |
| Cloudflare R2 | $5-10/month | Storage + operations, FREE egress |
| Neon PostgreSQL | $20-50/month | Scale tier with autoscaling |
| Vercel | $20/month | Pro tier, single team member |
| Cloudflare Domain | ~$10/year | dealinsights.ai |
| **TOTAL** | **$70-120/month** | |

**Comparison to Traditional AWS:**
- EC2 instance: $50-100/month
- RDS PostgreSQL: $40-80/month
- S3 + CloudFront: $20-50/month
- Load balancer: $20/month
- **AWS Total: $130-250/month**

**Savings: ~40-50% with better performance**

### Scaling Projections

**At 10,000 users:**
- Workers: $100-200/month
- R2: $50-100/month
- Database: $100-200/month
- Vercel: $20-40/month
- **Total: $270-540/month**

**At 100,000 users:**
- Workers: $500-1000/month
- R2: $300-500/month
- Database: $500-1000/month
- Vercel: $40-80/month
- **Total: $1,340-2,580/month**

### Cost Monitoring

```typescript
// Budget alerts configuration
{
  cloudflare: {
    monthlyBudget: 50,
    alertThreshold: 80, // Alert at 80% of budget
  },
  vercel: {
    monthlyBudget: 25,
    alertThreshold: 90,
  },
  neon: {
    monthlyBudget: 60,
    alertThreshold: 85,
  }
}
```

---

## 7. Implementation Timeline

### Phase 1: Infrastructure Setup (Week 1)
- Set up Cloudflare account and configure Workers
- Create R2 bucket with encryption
- Configure Neon PostgreSQL and Hyperdrive
- Set up Vercel project
- Configure DNS for dealinsights.ai

### Phase 2: Backend Migration (Weeks 2-4)
- Rewrite FastAPI endpoints in TypeScript/Hono
- Implement authentication middleware
- Migrate database queries to Drizzle ORM
- Implement document upload/download with R2
- Add security controls and logging

### Phase 3: Frontend Updates (Week 5)
- Update API endpoint URLs
- Add error handling for new backend
- Test all user flows end-to-end

### Phase 4: Testing & Security (Week 6)
- Penetration testing
- Security audit
- Performance testing
- Load testing

### Phase 5: Production Launch (Week 7)
- Deploy to production
- Monitor for 48 hours
- Gradual user migration
- Documentation and handoff

---

## 8. Success Criteria

- [ ] All API endpoints migrated and functional
- [ ] Document upload/download with encryption working
- [ ] Authentication and authorization enforced
- [ ] Audit logging capturing all operations
- [ ] Security controls pass internal review
- [ ] Performance meets SLAs (p95 < 500ms)
- [ ] Cost within budget ($100/month baseline)
- [ ] Monitoring and alerting operational
- [ ] Incident response procedures documented
- [ ] Team trained on new infrastructure

---

## 9. Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Migration bugs | Comprehensive testing, gradual rollout |
| Performance issues | Load testing, autoscaling configured |
| Security vulnerabilities | Security audit, penetration testing |
| Cost overruns | Budget alerts, usage monitoring |
| Downtime during migration | Blue-green deployment, rollback plan |
| Data loss | Automated backups, point-in-time recovery |

---

## Appendix A: Technology Stack

**Frontend:**
- Framework: Next.js 14
- Hosting: Vercel
- Language: TypeScript
- State Management: React Query

**Backend:**
- Runtime: Cloudflare Workers
- Framework: Hono
- Language: TypeScript
- Database ORM: Drizzle

**Infrastructure:**
- Database: Neon PostgreSQL
- Object Storage: Cloudflare R2
- CDN: Cloudflare
- DNS: Cloudflare
- CI/CD: GitHub Actions

**Security:**
- Authentication: JWT
- Encryption: AES-256 (at rest), TLS 1.3 (in transit)
- Secrets: Cloudflare Workers Secrets
- Audit Logs: PostgreSQL

---

## Appendix B: References

- [Cloudflare Workers Documentation](https://developers.cloudflare.com/workers/)
- [Cloudflare R2 Documentation](https://developers.cloudflare.com/r2/)
- [Cloudflare Hyperdrive](https://developers.cloudflare.com/hyperdrive/)
- [Neon PostgreSQL](https://neon.tech/docs)
- [Vercel Deployment](https://vercel.com/docs)
- [Hono Framework](https://hono.dev/)
- [OWASP Security Guidelines](https://owasp.org/)
