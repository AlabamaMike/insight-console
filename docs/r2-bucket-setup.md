# Cloudflare R2 Bucket Configuration

This document provides the configuration for setting up the Cloudflare R2 bucket for document storage.

## Bucket Configuration

### Production Bucket

**Name:** `insight-console-docs-prod`

**Settings:**
- Location: `auto` (automatically chooses optimal location)
- Storage Class: `Standard`
- Public Access: **Disabled** (private bucket)

### CORS Policy

```json
{
  "allowedOrigins": ["https://dealinsights.ai"],
  "allowedMethods": ["GET", "PUT"],
  "allowedHeaders": ["*"],
  "maxAgeSeconds": 3600
}
```

### Lifecycle Rules

```json
[
  {
    "id": "delete-old-soft-deleted",
    "status": "Enabled",
    "filter": { "prefix": "deleted/" },
    "expiration": { "days": 30 }
  }
]
```

**Purpose:** Automatically delete soft-deleted documents after 30-day retention period.

## Security Configuration

### Encryption
- **At Rest:** AES-256 encryption (Cloudflare-managed keys by default)
- **In Transit:** TLS 1.3 enforced by Cloudflare

### Access Control
- **No public access** - bucket is completely private
- **Access method:** Presigned URLs only, generated by Cloudflare Workers
- **URL expiration:**
  - Upload URLs: 15 minutes
  - Download URLs: 5 minutes

### Document Path Structure

```
{firm_id}/{deal_id}/{uuid}.{ext}

Examples:
- acme-capital/deal-123/a7b8c9d0-e1f2-4567-89ab-cdef01234567.pdf
- sequoia-ventures/deal-456/b1c2d3e4-f5a6-7890-bcde-f0123456789a.docx
```

**Security features:**
- Non-guessable UUIDs prevent enumeration attacks
- Firm ID prefix enables efficient querying and isolation
- No directory listing enabled

## Setup Instructions

### 1. Create R2 Bucket

```bash
# Using Wrangler CLI
wrangler r2 bucket create insight-console-docs-prod
```

### 2. Configure CORS

```bash
# Create CORS configuration file
cat > r2-cors.json << 'EOF'
[
  {
    "AllowedOrigins": ["https://dealinsights.ai"],
    "AllowedMethods": ["GET", "PUT"],
    "AllowedHeaders": ["*"],
    "MaxAgeSeconds": 3600
  }
]
EOF

# Apply CORS configuration
wrangler r2 bucket cors put insight-console-docs-prod --config r2-cors.json
```

### 3. Configure Lifecycle Rules

```bash
# Create lifecycle rules file
cat > r2-lifecycle.json << 'EOF'
{
  "Rules": [
    {
      "ID": "delete-old-soft-deleted",
      "Status": "Enabled",
      "Filter": {
        "Prefix": "deleted/"
      },
      "Expiration": {
        "Days": 30
      }
    }
  ]
}
EOF

# Apply lifecycle rules
wrangler r2 bucket lifecycle put insight-console-docs-prod --config r2-lifecycle.json
```

### 4. Bind to Workers

The bucket is bound to Cloudflare Workers via the `wrangler.toml` configuration:

```toml
[env.production]
r2_buckets = [
  { binding = "DOCUMENTS", bucket_name = "insight-console-docs-prod" }
]
```

## File Type Restrictions

**Allowed types:**
- PDF: `application/pdf`
- Word: `application/vnd.openxmlformats-officedocument.wordprocessingml.document`
- Excel: `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`

**Maximum file size:** 50MB

## Monitoring

### Metrics to Track
- Storage usage (GB)
- Number of objects stored
- Request volume (reads/writes)
- Bandwidth usage
- Average request latency

### Cost Monitoring
- Storage cost: $0.015/GB/month
- Class A operations (writes): $4.50/million
- Class B operations (reads): $0.36/million
- Egress: **FREE** (major cost advantage over S3)

## Backup and Disaster Recovery

### Backup Strategy
- R2 provides built-in durability (11 nines)
- All documents also referenced in PostgreSQL audit logs
- Point-in-time recovery available via audit trail

### Disaster Recovery
- Cross-region replication handled automatically by Cloudflare
- Documents can be reconstructed from source if needed
- Retention policy: 7 years for compliance

## Development Environment

For development/testing, create a separate bucket:

```bash
wrangler r2 bucket create insight-console-docs-dev
```

Update `wrangler.toml`:

```toml
[env.development]
vars = { ENVIRONMENT = "development" }
r2_buckets = [
  { binding = "DOCUMENTS", bucket_name = "insight-console-docs-dev" }
]
```

## Security Checklist

- [ ] Bucket is private (no public access)
- [ ] CORS configured for production domain only
- [ ] Lifecycle rules configured for soft-deleted documents
- [ ] Presigned URLs have short expiration times
- [ ] File type restrictions enforced at upload
- [ ] File size limits enforced (50MB)
- [ ] Document paths use non-guessable UUIDs
- [ ] All access logged to audit trail
- [ ] Encryption at rest enabled
- [ ] TLS 1.3 enforced for all connections

## Troubleshooting

### Issue: "Access Denied" errors
- Verify bucket binding in wrangler.toml
- Check that presigned URL hasn't expired
- Confirm CORS settings match origin domain

### Issue: Upload failures
- Check file size (must be < 50MB)
- Verify content-type is allowed
- Ensure presigned URL is still valid (15 min limit)

### Issue: High costs
- Review storage usage trends
- Check for abandoned uploads
- Verify lifecycle rules are working
- Monitor request patterns for abuse

## References

- [Cloudflare R2 Documentation](https://developers.cloudflare.com/r2/)
- [R2 Pricing](https://developers.cloudflare.com/r2/pricing/)
- [Presigned URLs](https://developers.cloudflare.com/r2/api/workers/workers-api-usage/#generating-presigned-urls)
